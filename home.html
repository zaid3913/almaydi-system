<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title> العميدي للألكترونيات </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400  ;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css  " rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js  "></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js  "></script>
  <style>
    body{margin:0;
        font-family:'Cairo',sans-serif;
        background:#f8f9fa;
    }

    .sidebar{
        position:fixed;
        top:0;
        right:0;
        width:220px;
        height:100vh;
        background:#3c556e;
        color:#fff;
        padding:20px;
        box-sizing:border-box;
        overflow-y: auto; /* إضافة شريط تمرير عند الحاجة */
    }

    .sidebar h2{
        text-align:center;
        font-size:20px;
        margin-bottom:25px;
    }

    .sidebar ul{
        list-style:none;
        padding:0;
    }

    .sidebar ul li{
        margin:15px 0;
    }

    .sidebar ul li a{
        display:block;
        padding:10px;
        background:#34495e;
        color:#fff;
        border-radius:4px;
        text-decoration:none;
        transition:.3s;
        cursor:pointer;
    }

    .sidebar ul li a:hover{
        background:#1abc9c;
    }

    .main{
        margin-right:220px;
        padding:30px;
    }

    .card{
        background:#fff;
        border-radius:8px;
        padding:25px;
        box-shadow:0 2px 8px rgba(0,0,0,.05);
        margin-bottom:25px;
    }

    .btn-primary{
        background:#1abc9c;
        border:none;
        padding:8px 18px;
        border-radius:4px;
        color:#fff;
        font-weight:600;
        cursor:pointer;
    }

    .btn-outline-success{
        background:transparent;
        color:#198754;
        border:1px solid #198754;
        padding:8px 16px;
        border-radius:4px;
        cursor:pointer;
    }

    table{
        width:100%;
        border-collapse:collapse;
    }

    th,td{padding:12px 10px;
        text-align:center;
    }

    thead{
        background:#f1f1f1;
    }

    .action-btns button{
        background:none;
        border:none;
        cursor:pointer;
        font-size:18px;
        margin:0 5px;
    }

    .search-box{
        margin-bottom:15px;
        display:flex;
        gap:10px;
        align-items:center;
    }

    input,select,textarea{
        width:100%;
        padding:8px;
        margin:4px 0 12px;
        border:1px solid #ccc;
        border-radius:4px;
        box-sizing:border-box;
    }

    .hidden{
        display:none;
    }

    .status-high{
        color:#388e3c;
        font-weight:bold;
    }

    .status-medium{
        color:#ffa000;
        font-weight:bold;
    }

    .status-low{
        color:#e64a19;
        font-weight:bold;
    }

    .status-out{
        color:#b71c1c;
        font-weight:bold;
    }

    .alert-box{
        background:#ffecec;
        border:1px solid #e57373;
        color:#b71c1c;
        padding:15px;
        border-radius:4px;
        margin-bottom:15px;
    }
   
    .chart-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.chart-controls button {
  padding: 5px 10px;
  font-size: 14px;
}

/* تعديلات لقسم سعر المنتج الحقيقي */
  #realPrice {
    margin-right: 240px; /* نفس مسافة باقي الأقسام */
    padding: 20px;
  }
  
  /* تعديلات للجدول في هذا القسم */
  #realPrice table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
  }
  
  #realPrice th, #realPrice td {
    padding: 10px;
    text-align: center;
    border: 1px solid #ddd;
  }
  
  #realPrice th {
    background-color: #f1f1f1;
  }
  
  /* تعديلات لحقول الإدخال */
  #realPrice input[type="number"] {
    width: 80px;
    padding: 5px;
    text-align: center;
  }
  
  /* تعديلات للأزرار */
  #realPrice .action-btns button {
    background: #1abc9c;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
  }

.expense-type {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .expense-type label {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    body.dark-mode {
  background-color: #121212;
  color: #f1f1f1;
}
body.dark-mode .sidebar {
  background-color: #1e1e1e;
}
body.dark-mode .card {
  background-color: #1e1e1e;
  color: #f1f1f1;
}
body.dark-mode input,
body.dark-mode select,
body.dark-mode textarea {
  background-color: #2c2c2c;
  color: #fff;
  border: 1px solid #555;
}

/* تعديل لون عناوين الحقول في الوضع الليلي */
body.dark-mode label {
  color: #f0ecec;
}

body.dark-mode input,
body.dark-mode select,
body.dark-mode textarea {
  color: #fff;
  background-color: #2c2c2c;
  border: 1px solid #555;
}

body.dark-mode input::placeholder,
body.dark-mode textarea::placeholder {
  color: #bbb;
}

/* لون رؤوس الجداول في الوضع العادي */
th {
  color: #000;
}

/* لون رؤوس الجداول في الوضع الليلي */
body.dark-mode th {
  color: #080000;
}

/* تأكد من أن الهامش الأيمن يتناسب مع الشريط الجانبي */
.main {
    margin-right: 240px; /* زيادة الهامش قليلاً */
    padding: 20px;
    overflow: hidden; /* لمنع أي تداخل */
}

/* تعديلات خاصة بقسم المصاريف */
#expenses {
    margin-right: 240px; /* نفس قيمة الهامش الأيمن */
    padding: 20px;
}

/* تحسين عرض الجدول في قسم المصاريف */
#expenses table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
}

#expenses th, #expenses td {
    padding: 10px;
    text-align: center;
    border: 1px solid #ddd;
}

#expenses th {
    background-color: #f1f1f1;
}

/* تحسين عرض حقول الإدخال */
#expenses input, #expenses select, #expenses textarea {
    width: 100%;
    padding: 8px;
    margin: 4px 0 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}

/* تحسين عرض الأزرار */
#expenses .action-btns button {
    background: #1abc9c;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

/* تحسين عرض مربع البحث */
#expenses .search-box {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
    align-items: center;
}

/* أنماط أزرار تسجيل الخروج */
.logout-btn {
    background: #e74c3c !important; /* اللون الأحمر */
    color: white !important;
    border: none;
    padding: 10px;
    width: 100%;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 15px;
    transition: background 0.3s;
}

.logout-btn:hover {
    background: #c0392b !important; /* لون أحمر داكن عند التحويم */
}

/* أنماط التقارير المالية */
.financial-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.financial-card {
  background: #fff;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  text-align: center;
}

.financial-card h4 {
  margin: 0 0 10px 0;
  color: #3c556e;
}

.financial-card p {
  font-size: 20px;
  font-weight: bold;
  margin: 0;
  color: #1abc9c;
}

/* لون سلبي للخسائر */
.negative-profit {
  color: #e74c3c !important;
}

#settings {
  margin-right: 240px;
  padding: 20px;
  box-sizing: border-box;
  overflow-x: hidden;
}

  </style>
</head>
<body>

<!-- ===== Sidebar ===== -->
<div class="sidebar">
  <h2> العميدي للألكترونيات</h2>
  <ul>
    <li><a onclick="showSection('products')">المنتجات</a></li>
    <li><a onclick="showSection('sales')">المبيعات</a></li>
    <li><a onclick="showSection('reports')">التقارير</a></li>
    <li><a onclick="showSection('store')">المخزن</a></li>
    <li><a onclick="showSection('debts')">الديون</a></li>
    <li><a onclick="showSection('realPrice')">سعر المنتج الحقيقي</a></li>
    <li><a onclick="showSection('expenses')">المصاريف</a></li>
    <li><a onclick="showSection('settings')">الإعدادات</a></li>
     <li><button class="logout-btn" onclick="logout()"><i class="bi bi-box-arrow-left"></i> تسجيل الخروج</button></li>
  </ul>
</div>

<!-- ===== Main Container ===== -->
<div class="main">

<!-- 1. قسم المنتجات -->
<div id="products" class="section">
  <h1>إدارة المنتجات</h1>
  <div class="card">
    <button class="btn-primary" onclick="toggleForm('productForm')">
      <i class="bi bi-plus-circle"></i> إضافة منتج جديد
    </button>
  </div>

<label>باركود المنتج</label>
<input type="text" id="prodBarcodeScan" placeholder="مسح أو إدخال يدوي">

<script>
  document.getElementById("prodBarcodeScan").addEventListener("input", function() {
    document.getElementById("prodBarcode").value = this.value;
  });
</script>

<button type="button" class="btn-outline-success" onclick="startBarcodeScanner('product')">
  <i class="bi bi-upc-scan"></i> مسح باركود
</button>
<div id="barcodeScanner" style="display:none; margin:10px 0;">
  <div id="scannerContainer" style="width:100%; height:200px; border:1px solid #ccc;"></div>
  <button type="button" class="btn-outline-success" onclick="stopBarcodeScanner()">إيقاف</button>
</div>

  <div id="productForm" class="card hidden">
    <h3>إضافة منتج جديد</h3>
    <form onsubmit="saveProduct(event)">
      <input type="hidden" id="productId">
      <label>الاسم</label><input type="text" id="prodName" required>
      <label>النوع</label><input type="text" id="prodType" required>
      <label>باركود المنتج</label>
      <input type="text" id="prodBarcode" placeholder="مسح أو إدخال يدوي">
      <label>السعر (دينار عراقي)</label><input type="number" id="prodPrice" min="0" required>
      <label>الكمية</label><input type="number" id="prodQty" min="0" required>
      <label>ملاحظات</label><textarea id="prodNotes"></textarea>
      <button type="submit" class="btn-primary">حفظ</button>
      <button type="button" class="btn-outline-success" onclick="toggleForm('productForm')">إلغاء</button>
    </form>
  </div>
  <div class="card">
    <h3>قائمة المنتجات</h3>
    <div class="search-box">
      <input type="text" id="prodSearch" placeholder="ابحث بالاسم أو النوع..." oninput="filterProducts()">
      <button class="btn-outline-success" onclick="exportProductsCSV()">تصدير Excel</button>
    </div>
    <table>
      <thead>
  <tr>
    <th>#</th>
    <th>الاسم</th>
    <th>النوع</th>
    <th>الباركود</th>
    <th>الكمية</th>
    <th>السعر (دينار عراقي)</th>
    <th>ملاحظات</th>
    <th>إجراءات</th>
  </tr>
</thead>
      <tbody id="productTableBody"></tbody>
    </table>
  </div>
</div>

<!-- 2. قسم المبيعات -->
<div id="sales" class="section hidden">
  <h1>إصدار فاتورة مبيعات</h1>
  <div class="card">
    <label>اختر المنتج</label><select id="saleProductSelect"></select>
    <div style="margin:10px 0;">
  <label>أو امسح الباركود</label>
<input type="text" id="saleBarcode" placeholder="امسح هنا" onkeyup="handleBarcodeSale(this.value)" oninput="this.value=this.value.trim()">
    <i class="bi bi-upc-scan"></i> مسح
  </button>
</div>
    <label>الكمية</label><input type="number" id="saleQty" min="1" value="1" oninput="calcLineTotal()">
    <label>السعر الكلي (دينار عراقي)</label><input type="number" id="saleLineTotal" readonly>
    <button class="btn-primary" onclick="addToInvoice()">إضافة إلى الفاتورة</button>
  </div>
  <div class="card">
    <h3>الفاتورة الحالية</h3>
    <table>
      <thead><tr><th>#</th><th>المنتج</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th><th>حذف</th></tr></thead>
      <tbody id="invoiceBody"></tbody>
    </table>
  </div>
  <div class="card">
    <label>الإجمالي قبل الخصم (دينار عراقي)</label><input type="number" id="grandTotal" readonly>
    <label>الخصم</label><input type="number" id="discount" min="0" value="0" oninput="calcFinal()">
    <label>صافي الفاتورة</label><input type="number" id="netTotal" readonly>
    <label>المبلغ المدفوع</label><input type="number" id="paid" min="0" oninput="calcChange()">
    <label>الباقي</label><input type="number" id="change" readonly>
    <button class="btn-primary" onclick="confirmSale()">تأكيد البيع وطباعة</button>
  </div>
</div>

<!-- 3. قسم التقارير -->
<div id="reports" class="section hidden">
  <h1>التقارير</h1>
  <div class="card">
    <label>من</label><input type="date" id="fromDate">
    <label>إلى</label><input type="date" id="toDate">
    <button class="btn-primary" onclick="filterReports()">عرض</button>
    <button class="btn-outline-success" onclick="exportReportCSV()">تصدير Excel</button>
  </div>
  <div class="card">
    <h3>رسم بياني للمبيعات</h3>
    <div id="salesChartContainer">
      <canvas id="salesChart"></canvas>
    </div>
  </div>

<div class="card">
  <h3>التقرير المالي</h3>
  <div class="chart-controls">
    <button onclick="filterFinancialReport('today')">اليوم</button>
    <button onclick="filterFinancialReport('week')">أسبوع</button>
    <button onclick="filterFinancialReport('month')">شهر</button>
    <button onclick="filterFinancialReport('year')">سنة</button>
    <button onclick="filterFinancialReport('all')">الكل</button>
  </div>
  
  <div class="financial-summary">
    <div class="financial-card">
      <h4>إجمالي المبيعات</h4>
      <p id="totalSales">0 د.ع</p>
    </div>
    <div class="financial-card">
      <h4>إجمالي المصاريف</h4>
      <p id="totalExpenses">0 د.ع</p>
    </div>
    <div class="financial-card">
      <h4>الربح الإجمالي</h4>
      <p id="grossProfit">0 د.ع</p>
    </div>
    <div class="financial-card">
      <h4>الربح الصافي</h4>
      <p id="netProfit">0 د.ع</p>
    </div>
  </div>
</div>

  <div class="card">
    <h3>سجل المبيعات</h3>
    <div class="search-box">
      <input type="text" id="reportSearch" placeholder="ابحث برقم الفاتورة..." oninput="filterReportTable()">
    </div>
    <table>
      <thead>
        <tr>
          <th>رقم الفاتورة</th>
          <th>التاريخ</th>
          <th>المنتجات</th>
          <th>الكمية</th>
          <th>الإجمالي</th>
          <th>المدفوع</th>
          <th>الباقي</th>
        </tr>
      </thead>
      <tbody id="reportTableBody"></tbody>
    </table>
  </div>
</div>

<!-- 4. قسم المخزن -->
<div id="store" class="section hidden">
  <h1>إدارة المخزن</h1>
  <div class="card">
    <label>اسم المنتج</label><input type="text" id="searchName" oninput="filterStore()">
    <label>النوع</label><input type="text" id="searchType" oninput="filterStore()">
    <label>حالة الكمية</label>
    <select id="searchStatus" onchange="filterStore()">
      <option value="">الكل</option>
      <option value="high">عالية</option>
      <option value="medium">متوسطة</option>
      <option value="low">منخفضة</option>
      <option value="out">منتهية</option>
    </select>
  </div>
  <div id="alertBox" class="card alert-box hidden">
    <h4><i class="bi bi-exclamation-triangle-fill"></i> تنبيهات المخزون</h4>
    <ul id="alertList"></ul>
  </div>
  <div class="card">
    <h3>جدول المخزون</h3>
    <table>
      <thead><tr><th>#</th><th>الاسم</th><th>النوع</th><th>الكمية</th><th>الحالة</th></tr></thead>
      <tbody id="storeTableBody"></tbody>
    </table>
  </div>
  <div class="card">
    <button class="btn-outline-success" onclick="exportStoreCSV()">
      <i class="bi bi-file-earmark-excel"></i> تصدير Excel
    </button>
  </div>
</div>

<!-- 5. قسم الديون-->
  <div id="debts" class="section hidden">
    <h1>إدارة الديون</h1>
    
    <div class="card">
      <button class="btn-primary" onclick="toggleForm('debtForm')">
        <i class="bi bi-plus-circle"></i> إضافة دين جديد
      </button>
    </div>
    
    <div id="debtForm" class="card hidden">
      <h3>تسجيل دين جديد</h3>
      <form onsubmit="saveDebt(event)">
        <input type="hidden" id="debtId">
        <label>اسم المدين</label><input type="text" id="debtName" required>
        <label>رقم الهاتف</label><input type="text" id="debtPhone">
        <label>المبلغ (دينار عراقي)</label><input type="number" id="debtAmount" min="0" required>
        <label>تاريخ الاستحقاق</label><input type="date" id="debtDueDate">
        <label>ملاحظات</label><textarea id="debtNotes"></textarea>
        <button type="submit" class="btn-primary">حفظ</button>
        <button type="button" class="btn-outline-success" onclick="toggleForm('debtForm')">إلغاء</button>
      </form>
    </div>
    
    <div class="card">
      <h3>قائمة الديون</h3>
      <div class="search-box">
        <input type="text" id="debtSearch" placeholder="ابحث باسم المدين..." oninput="filterDebts()">
        <button class="btn-outline-success" onclick="exportDebtsCSV()">تصدير Excel</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>اسم الزبون</th>
            <th>رقم الهاتف</th>
            <th>المبلغ</th>
            <th>تاريخ التسجيل</th>
            <th>تاريخ الاستحقاق</th>
            <th>الحالة</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="debtTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 6.قسم اسعار المنتجات الحقيقية-->
<div id="realPrice" class="section hidden">
  <h1>إدارة أسعار المنتجات الحقيقية</h1>
  <div class="card">
    <h3>تعريف الأسعار الحقيقية للمنتجات</h3>
    <div class="search-box">
      <input type="text" id="realPriceSearch" placeholder="ابحث بالاسم أو النوع..." oninput="filterRealPrices()">
    </div>
    
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>المنتج</th>
          <th>النوع</th>
          <th>سعر البيع</th>
          <th>السعر الحقيقي</th>
          <th>الربح</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="realPriceTableBody"></tbody>
    </table>
  </div>
</div>


<!-- 7. قسم المصاريف-->
<div id="expenses" class="section hidden">
  <h2>إدارة المصاريف</h2>
  
  <div class="card">
    <button class="btn-primary" onclick="toggleForm('expenseForm')">
      <i class="bi bi-plus-circle"></i> إضافة مصروف جديد
    </button>
  </div>
  
  <div id="expenseForm" class="card hidden">
    <h3>تسجيل مصروف جديد</h3>
    <form onsubmit="saveExpense(event)">
      <input type="hidden" id="expenseId">
      <label>اسم المصروف</label>
      <input type="text" id="expenseName" required>
      
      <label>المبلغ (دينار عراقي)</label>
      <input type="number" id="expenseAmount" min="0" required>
      
      <label>التاريخ</label>
      <input type="date" id="expenseDate" required>
      
      <label>نوع المصروف</label>
      <div class="expense-type">
        <label><input type="radio" name="expenseType" value="تشغيلية" checked> تشغيلية</label>
        <label><input type="radio" name="expenseType" value="صيانة"> صيانة</label>
        <label><input type="radio" name="expenseType" value="رواتب"> رواتب</label>
        <label><input type="radio" name="expenseType" value="أخرى"> أخرى</label>
      </div>
      
      <label>ملاحظات</label>
      <textarea id="expenseNotes"></textarea>
      
      <button type="submit" class="btn-primary">حفظ</button>
      <button type="button" class="btn-outline-success" onclick="toggleForm('expenseForm')">إلغاء</button>
    </form>
  </div>
  
  <div class="card">
    <h3>سجل المصاريف</h3>
    <div class="search-box">
      <input type="text" id="expenseSearch" placeholder="ابحث باسم المصروف..." oninput="filterExpenses()">
      <button class="btn-outline-success" onclick="exportExpensesCSV()">تصدير Excel</button>
    </div>
    
    <div class="chart-controls">
      <button onclick="filterExpensesByType('all')">الكل</button>
      <button onclick="filterExpensesByType('تشغيلية')">تشغيلية</button>
      <button onclick="filterExpensesByType('صيانة')">صيانة</button>
      <button onclick="filterExpensesByType('رواتب')">رواتب</button>
      <button onclick="filterExpensesByType('أخرى')">أخرى</button>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>اسم المصروف</th>
          <th>المبلغ</th>
          <th>التاريخ</th>
          <th>النوع</th>
          <th>ملاحظات</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="expenseTableBody"></tbody>
    </table>
  </div>
</div>

<!-- 8. قسم الإعدادات -->
<div id="settings" class="section hidden">
  <h1><i class="bi bi-gear"></i> الإعدادات</h1>

  <!-- تبديل الوضع الليلي -->
  <div class="card">
    <h3>المظهر</h3>
    <button class="btn-primary" onclick="toggleDarkMode()">
      <i class="bi bi-moon" id="themeIcon"></i> تبديل الوضع
    </button>
  </div>

  <!-- إدارة المستخدمين -->
  <div class="card">
    <h3>إدارة المستخدمين</h3>
    <button class="btn-primary" onclick="toggleForm('userForm')">
      <i class="bi bi-person-plus"></i> إضافة مستخدم جديد
    </button>

    <!-- نموذج إضافة مستخدم -->
    <div id="userForm" class="card hidden">
      <h4>إضافة مستخدم جديد</h4>
      <form onsubmit="saveUser(event)">
        <input type="hidden" id="userId">
        <label>الاسم الكامل</label>
        <input type="text" id="userName" required>
        <label>البريد الإلكتروني</label>
        <input type="email" id="userEmail" required>
        <label>كلمة المرور</label>
        <input type="password" id="userPassword" required>
        <label>نوع الحساب</label>
        <select id="userRole">
          <option value="admin">أدمن</option>
          <option value="user">يوزر</option>
        </select>
        <button type="submit" class="btn-primary">حفظ</button>
        <button type="button" class="btn-outline-success" onclick="toggleForm('userForm')">إلغاء</button>
      </form>
    </div>

    <!-- جدول المستخدمين -->
    <div class="search-box">
      <input type="text" id="userSearch" placeholder="ابحث بالاسم أو البريد..." oninput="filterUsers()">
    </div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>الاسم</th>
          <th>البريد الإلكتروني</th>
          <th>الصلاحية</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="userTableBody"></tbody>
    </table>
  </div>
</div>

<script>
// ================== تهيئة Firebase ==================
const firebaseConfig = {
  apiKey: "AIzaSyB3T4pzPOvAw8mkfq_HXnpjPTR9orkj0ms",
  authDomain: "almaydi-system.firebaseapp.com",
  projectId: "almaydi-system",
  storageBucket: "almaydi-system.firebasestorage.app",
  messagingSenderId: "783507593229",
  appId: "1:783507593229:web:39087cbaa33268c62d5d44"
};

// تهيئة Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// تمكين وضع عدم الاتصال
firebase.firestore().enablePersistence()
  .catch((err) => {
    if (err.code == 'failed-precondition') {
      console.log('وضع عدم الاتصال غير متاح في علامة تبويب أخرى مفتوحة');
    } else if (err.code == 'unimplemented') {
      console.log('المتصفح لا يدعم وضع عدم الاتصال');
    }
  });

// ================== بيانات عالمية ==================
let products = [];
let invoices = [];
let invoiceLines = [];
let debts = [];
let expenses = [];
let productRealPrices = {};
let users = [];
let salesChart = null;
let isScanning = false;

// تأمين الصفحة الرئيسية
if(localStorage.getItem('isLoggedIn') !== 'true') {
  window.location.href = 'index.html';
}

// دالة تسجيل الخروج
function logout() {
  localStorage.removeItem('isLoggedIn');
  window.location.href = 'index.html';
}

// ================== دوال Firebase المساعدة ==================
// دالة لحفظ البيانات في Firestore
function saveToFirestore(collection, data) {
  return db.collection(collection).doc(data.id.toString()).set(data);
}

// دالة لحذف البيانات من Firestore
function deleteFromFirestore(collection, id) {
  return db.collection(collection).doc(id.toString()).delete();
}

// دالة لتحميل البيانات من Firestore
function loadFromFirestore(collection, callback) {
  db.collection(collection).onSnapshot((snapshot) => {
    const data = [];
    snapshot.forEach((doc) => {
      data.push(doc.data());
    });
    callback(data);
  });
}

// ================== التنقل بين الأقسام ==================
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
  document.getElementById(id)?.classList.remove('hidden');
  
  if (id === 'products') {
    loadProducts();
  }
  if (id === 'sales') {
    loadProducts().then(() => refreshSaleSelect());
  }
  if (id === 'debts') {
    loadDebts();
  }
  if (id === 'reports') { 
    loadInvoices().then(() => {
      filterReports(); 
      renderReportTable(invoices); 
      calculateFinancialReport();
    });
  }
  if (id === 'store') { 
    loadProducts().then(() => {
      renderStoreTable(); 
      checkStockAlerts();
    });
  }
  if (id === 'realPrice') {
    loadProducts().then(() => renderRealPrices());
  }
  if (id === 'expenses') {
    loadExpenses();
  }
  if (id === 'settings') {
    loadUsers();
  }
}

// ================== دوال التحميل من Firestore ==================
// تحميل المنتجات
async function loadProducts() {
  return new Promise((resolve) => {
    db.collection('products').onSnapshot((snapshot) => {
      products = [];
      snapshot.forEach((doc) => {
        products.push(doc.data());
      });
      renderProducts();
      resolve();
    });
  });
}

// تحميل الفواتير
async function loadInvoices() {
  return new Promise((resolve) => {
    db.collection('invoices').orderBy('date', 'desc').onSnapshot((snapshot) => {
      invoices = [];
      snapshot.forEach((doc) => {
        invoices.push(doc.data());
      });
      resolve();
    });
  });
}

// تحميل الديون
function loadDebts() {
  db.collection('debts').orderBy('date', 'desc').onSnapshot((snapshot) => {
    debts = [];
    snapshot.forEach((doc) => {
      debts.push(doc.data());
    });
    renderDebts();
  });
}

// تحميل المصاريف
function loadExpenses() {
  db.collection('expenses').orderBy('date', 'desc').onSnapshot((snapshot) => {
    expenses = [];
    snapshot.forEach((doc) => {
      expenses.push(doc.data());
    });
    renderExpenses();
  });
}

// تحميل أسعار المنتج الحقيقية
function loadRealPrices() {
  db.collection('productRealPrices').onSnapshot((snapshot) => {
    productRealPrices = {};
    snapshot.forEach((doc) => {
      productRealPrices[doc.id] = doc.data().price;
    });
  });
}

// تحميل المستخدمين
function loadUsers() {
  db.collection('users').onSnapshot((snapshot) => {
    users = [];
    snapshot.forEach((doc) => {
      users.push(doc.data());
    });
    renderUsers();
  });
}

// ================== 1. قسم المنتجات ==================
function toggleForm(formId){
  document.getElementById(formId).classList.toggle('hidden');
}

function saveProduct(e){
  e.preventDefault();
  const id = document.getElementById('productId').value || Date.now();
  const product = {
    id:+id,
    name: document.getElementById('prodName').value.trim(),
    type: document.getElementById('prodType').value.trim(),
    barcode: document.getElementById('prodBarcode').value.trim(),
    price:+document.getElementById('prodPrice').value,
    quantity:+document.getElementById('prodQty').value,
    notes: document.getElementById('prodNotes').value.trim()
  };
  
  saveToFirestore('products', product).then(() => {
    // حفظ السعر الحقيقي
    if (!productRealPrices[product.id]) {
      const realPrice = Math.round(product.price * 0.8);
      db.collection('productRealPrices').doc(product.id.toString()).set({ price: realPrice });
    }
    toggleForm('productForm');
  });
}

function renderProducts(){
  const tbody=document.getElementById('productTableBody');
  tbody.innerHTML='';
  products.forEach((p,i)=>{
    tbody.innerHTML+=`<tr>
      <td>${i+1}</td>
      <td>${p.name}</td>
      <td>${p.type}</td>
      <td>${p.barcode || '-'}</td>
      <td>${p.quantity}</td>
      <td>${p.price.toLocaleString()}</td>
      <td>${p.notes}</td>
      <td class="action-btns">
        <button onclick="editProduct(${p.id})"><i class="bi bi-pencil-square"></i></button>
        <button onclick="deleteProduct(${p.id})"><i class="bi bi-trash"></i></button>
      </td>
    </tr>`;
  });
}

function editProduct(id){
  const p=products.find(pr=>pr.id===id);
  if(!p)return;
  document.getElementById('productId').value=p.id;
  document.getElementById('prodName').value=p.name;
  document.getElementById('prodType').value=p.type;
  document.getElementById('prodBarcode').value=p.barcode || '';
  document.getElementById('prodPrice').value=p.price;
  document.getElementById('prodQty').value=p.quantity;
  document.getElementById('prodNotes').value=p.notes;
  toggleForm('productForm');
}

function deleteProduct(id){
  if(!confirm('هل أنت متأكد من الحذف؟'))return;
  deleteFromFirestore('products', id).then(() => {
    // حذف السعر الحقيقي أيضاً
    db.collection('productRealPrices').doc(id.toString()).delete();
  });
}

// ================== 2. قسم المبيعات ==================
function refreshSaleSelect(){
  const sel=document.getElementById('saleProductSelect');
  sel.innerHTML='<option value="">-- اختر منتج --</option>';
  products.forEach(p=>{
    if(p.quantity>0){
      const opt=document.createElement('option');
      opt.value=p.id;
      opt.textContent=`${p.name} (${p.type}) - ${p.price.toLocaleString()} د.ع`;
      sel.appendChild(opt);
    }
  });
}

function confirmSale(){
  if(invoiceLines.length===0){alert('الفاتورة فارغة');return;}
  const net=+document.getElementById('netTotal').value;
  const paid=+document.getElementById('paid').value;
  if(paid<net){alert('المبلغ المدفوع غير كافي');return;}
  
  const batch = db.batch();
  
  // تحديث كميات المنتجات
  invoiceLines.forEach(l=>{
    const p=products.find(pr=>pr.id===l.productId);
    const newQuantity = p.quantity - l.qty;
    const productRef = db.collection('products').doc(l.productId.toString());
    batch.update(productRef, { quantity: newQuantity });
  });
  
  // حفظ الفاتورة
  const invoice = {
    id: Date.now(),
    date: new Date().toLocaleString('ar-IQ'),
    lines: [...invoiceLines],
    total: net,
    paid,
    change: paid-net
  };
  
  batch.set(db.collection('invoices').doc(invoice.id.toString()), invoice);
  
  batch.commit().then(() => {
    invoiceLines=[];
    renderInvoice();
    document.getElementById('discount').value=0;
    document.getElementById('paid').value='';
    loadProducts();
  });
}

// ================== 3. قسم التقارير ==================
function filterReports() {
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  const filtered = invoices.filter(inv => {
    if (!from && !to) return true;
    const d = new Date(inv.date.split(',')[0].split('/').reverse().join('-'));
    const fromD = from ? new Date(from) : null;
    const toD = to ? new Date(to) : null;
    if (fromD && d < fromD) return false;
    if (toD && d > toD) return false;
    return true;
  });
  
  renderReportTable(filtered);
  renderChart(filtered);
  calculateFinancialReport(from, to);
}

function exportReportCSV(){
  let csv='\uFEFFرقم الفاتورة,التاريخ,المنتجات,الكمية,الإجمالي,المدفوع,الباقي\n';
  invoices.forEach(inv=>{
    let prods='', qty=0;
    inv.lines.forEach(l=>{
      const p=products.find(pr=>pr.id===l.productId);
      prods+=p.name+' ('+l.qty+'); ';
      qty+=l.qty;
    });
    csv+=`${inv.id},${inv.date},"${prods.slice(0,-2)}",${qty},${inv.total},${inv.paid},${inv.change}\n`;
  });
  downloadCSV(csv,'sales_report.csv');
}

// ================== 4. قسم المخزن ==================
function checkStockAlerts(){
  const low=products.filter(p=>p.quantity<5);
  const box=document.getElementById('alertBox');
  const list=document.getElementById('alertList');
  list.innerHTML='';
  if(low.length){
    box.classList.remove('hidden');
    low.forEach(p=>list.innerHTML+=`<li>${p.name} (${p.type}) – الكمية: ${p.quantity}</li>`);
  }else box.classList.add('hidden');
}

// ================== 6. دوال قسم الديون ==================
function saveDebt(e) {
  e.preventDefault();
  const id = document.getElementById('debtId').value || Date.now();
  const debt = {
    id: +id,
    name: document.getElementById('debtName').value.trim(),
    phone: document.getElementById('debtPhone').value.trim(),
    amount: +document.getElementById('debtAmount').value,
    dueDate: document.getElementById('debtDueDate').value,
    date: new Date().toLocaleDateString('ar-IQ'),
    notes: document.getElementById('debtNotes').value.trim(),
    paid: false
  };
  
  saveToFirestore('debts', debt).then(() => {
    renderDebts();
    toggleForm('debtForm');
  });
}

function deleteDebt(id) {
  if (!confirm('هل أنت متأكد من حذف هذا الدين؟')) return;
  deleteFromFirestore('debts', id);
}

// ================== قسم سعر المنتج الحقيقي ==================
function updateRealPrice(productId) {
  const input = document.getElementById(`realPrice_${productId}`);
  const newPrice = parseInt(input.value) || 0;
  
  db.collection('productRealPrices').doc(productId.toString()).set({ price: newPrice })
    .then(() => {
      productRealPrices[productId] = newPrice;
      renderRealPrices();
    });
}

function setDefaultRealPrice(productId) {
  const product = products.find(p => p.id === productId);
  if (product) {
    const defaultPrice = Math.round(product.price * 0.8);
    updateRealPrice(productId, defaultPrice);
  }
}

// ================== دوال قسم المصاريف ==================
function saveExpense(e) {
  e.preventDefault();
  const id = document.getElementById('expenseId').value || Date.now();
  const expense = {
    id: +id,
    name: document.getElementById('expenseName').value.trim(),
    amount: +document.getElementById('expenseAmount').value,
    date: document.getElementById('expenseDate').value,
    type: document.querySelector('input[name="expenseType"]:checked').value,
    notes: document.getElementById('expenseNotes').value.trim()
  };
  
  saveToFirestore('expenses', expense).then(() => {
    toggleForm('expenseForm');
  });
}

function deleteExpense(id) {
  if (!confirm('هل أنت متأكد من حذف هذا المصروف؟')) return;
  deleteFromFirestore('expenses', id);
}

// ================== قسم الإعدادات ==================
function saveUser(e) {
  e.preventDefault();
  const id = document.getElementById('userId').value || Date.now();
  const user = {
    id: +id,
    name: document.getElementById('userName').value.trim(),
    email: document.getElementById('userEmail').value.trim(),
    password: document.getElementById('userPassword').value.trim(),
    role: document.getElementById('userRole').value
  };

  saveToFirestore('users', user).then(() => {
    toggleForm('userForm');
    e.target.reset();
  });
}

function deleteUser(id) {
  if (!confirm('هل أنت متأكد من حذف هذا المستخدم؟')) return;
  deleteFromFirestore('users', id);
}

// ================== تهيئة النظام ==================
document.addEventListener('DOMContentLoaded', function() {
  // تحميل جميع البيانات عند بدء التشغيل
  loadProducts();
  loadRealPrices();
  loadUsers();
  loadExpenses();
  loadDebts();
  loadInvoices();
  
  showSection('products');
});
</script>
</body>
</html>
